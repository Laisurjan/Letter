<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æ‡‰ç”¨æ–‡ï½œç¨±è¬‚ï¼†é¡Œè¾­ï¼ˆWordwallé¢¨ãƒ»é­”æ³•é…è‰²ãƒ»æˆç¸¾å¡ï¼‹å½©å¸¶ï¼‰</title>

  <!-- æˆç¸¾å¡åŒ¯å‡º PNG -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0b1220;
      --muted:#5b6476;
      --line:rgba(15,23,42,.10);

      --p1:#7c3aed;   /* ç´« */
      --p2:#06b6d4;   /* é’ */
      --p3:#f59e0b;   /* æ©™ */
      --p4:#22c55e;   /* ç¶  */
      --p5:#ec4899;   /* ç²‰ */

      --shadow: 0 18px 52px rgba(2,6,23,.14);
      --radius: 18px;

      --btn: rgba(2,6,23,.04);
      --btnHover: rgba(2,6,23,.07);

      --good: #16a34a;
      --bad:  #dc2626;

      --overlay: rgba(2,6,23,.58);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background: var(--bg);
      overflow-x:hidden;
    }

    /* âœ¨ æ›´è¯éº— aurora + æ¼‚æµ®æ˜Ÿé» */
    body::before{
      content:"";
      position:fixed; inset:-32vh -28vw;
      background:
        radial-gradient(1200px 680px at 10% 0%, rgba(124,58,237,.34), transparent 58%),
        radial-gradient(1000px 600px at 92% 8%, rgba(6,182,212,.28), transparent 58%),
        radial-gradient(920px 560px at 74% 118%, rgba(245,158,11,.20), transparent 55%),
        radial-gradient(920px 560px at -8% 104%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(1200px 760px at 46% 56%, rgba(236,72,153,.20), transparent 60%),
        radial-gradient(1400px 820px at 50% 50%, rgba(255,255,255,.55), transparent 62%);
      filter: blur(18px);
      opacity:.97;
      z-index:-2;
      animation: aurora 11s ease-in-out infinite alternate;
    }
    @keyframes aurora{
      0%{ transform: translate3d(-1.6%, -1.1%, 0) scale(1.00); }
      50%{ transform: translate3d(1.3%, .9%, 0) scale(1.03); }
      100%{ transform: translate3d(.3%, 1.6%, 0) scale(1.02); }
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background-image:
        radial-gradient(circle at 12% 18%, rgba(255,255,255,.9) 0 1px, transparent 2px),
        radial-gradient(circle at 78% 22%, rgba(255,255,255,.75) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 72%, rgba(255,255,255,.70) 0 1px, transparent 2px),
        radial-gradient(circle at 88% 78%, rgba(255,255,255,.70) 0 1px, transparent 2px),
        radial-gradient(circle at 20% 88%, rgba(255,255,255,.62) 0 1px, transparent 2px),
        radial-gradient(circle at 55% 15%, rgba(255,255,255,.55) 0 1px, transparent 2px),
        radial-gradient(circle at 62% 58%, rgba(255,255,255,.55) 0 1px, transparent 2px);
      opacity:.38;
      pointer-events:none;
      z-index:-1;
      animation: twinkle 6s ease-in-out infinite alternate;
    }
    @keyframes twinkle{
      0%{ opacity:.30; }
      100%{ opacity:.44; }
    }

    button{font:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px}

    header{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
      padding:10px 2px 14px;border-bottom:1px solid var(--line);
    }
    .title{display:flex;flex-direction:column;gap:6px}
    .title h1{
      margin:0;font-size:18px;letter-spacing:.2px;
      display:flex;align-items:center;gap:10px;
    }
    .badge{
      font-size:12px;padding:4px 10px;border-radius:999px;
      border:1px solid rgba(124,58,237,.24);
      background:
        radial-gradient(260px 70px at 20% 0%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(260px 70px at 80% 0%, rgba(6,182,212,.16), transparent 60%),
        rgba(255,255,255,.76);
      color:rgba(60,40,140,.95);
      white-space:nowrap;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
    }
    .title p{margin:0;color:var(--muted);font-size:13px;line-height:1.4}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border:1px solid var(--line); background:rgba(255,255,255,.76);
      padding:8px 10px;border-radius:999px;
      font-size:13px; cursor:pointer;
      backdrop-filter: blur(10px);
      display:flex;align-items:center;gap:8px;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
      transition:.15s;
      position:relative;
      overflow:hidden;
    }
    .pill::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg,
        rgba(124,58,237,.0),
        rgba(124,58,237,.22),
        rgba(6,182,212,.20),
        rgba(236,72,153,.18),
        rgba(245,158,11,.16),
        rgba(124,58,237,.0));
      opacity:.0;
      filter: blur(6px);
      transition:.18s;
    }
    .pill:hover{ transform: translateY(-1px); }
    .pill:hover::before{ opacity:.75; }
    .pill.active{
      border-color:rgba(124,58,237,.30);
      background:
        radial-gradient(520px 120px at 20% 0%, rgba(124,58,237,.26), transparent 60%),
        radial-gradient(520px 120px at 80% 0%, rgba(6,182,212,.22), transparent 60%),
        radial-gradient(520px 120px at 50% 120%, rgba(236,72,153,.16), transparent 60%),
        rgba(255,255,255,.86);
      color:#2a215d;
    }
    .pill.ghost{ background:rgba(255,255,255,.68); }
    .pill .dot{ width:8px;height:8px;border-radius:50%; background:rgba(2,6,23,.25); }
    .pill .dot.good{ background:rgba(22,163,74,.78); }
    .pill .dot.warn{ background:rgba(245,158,11,.82); }

    .card{
      margin-top:14px;
      background:rgba(255,255,255,.82);
      border:1px solid rgba(255,255,255,.32);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(14px);
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg,
        rgba(124,58,237,.16),
        rgba(6,182,212,.14),
        rgba(236,72,153,.12),
        rgba(245,158,11,.10));
      opacity:.22;
      pointer-events:none;
    }
    .card::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius:calc(var(--radius) + 2px);
      background: conic-gradient(from 180deg,
        rgba(124,58,237,.0),
        rgba(124,58,237,.22),
        rgba(6,182,212,.20),
        rgba(236,72,153,.18),
        rgba(245,158,11,.16),
        rgba(124,58,237,.0));
      filter: blur(10px);
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: screen;
    }

    .cardHead{
      position:relative;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      background:
        radial-gradient(820px 190px at 12% 0%, rgba(124,58,237,.28), transparent 60%),
        radial-gradient(820px 190px at 88% 0%, rgba(6,182,212,.24), transparent 60%),
        radial-gradient(820px 190px at 55% 110%, rgba(236,72,153,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.72));
      border-bottom:1px solid rgba(15,23,42,.10);
      backdrop-filter: blur(10px);
    }
    .cardHead .h{font-weight:950}
    .cardHead .sub{font-size:12px;color:var(--muted)}
    .cardBody{padding:14px; position:relative}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid rgba(15,23,42,.10);
      background:var(--btn);
      padding:10px 12px;border-radius:14px; cursor:pointer;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
      transition:.15s;
    }
    .btn:hover{background:var(--btnHover); transform: translateY(-1px); }
    .btn.primary{
      border-color:rgba(124,58,237,.24);
      background:
        radial-gradient(360px 90px at 20% 0%, rgba(124,58,237,.20), transparent 60%),
        radial-gradient(360px 90px at 80% 0%, rgba(6,182,212,.16), transparent 60%),
        rgba(255,255,255,.74);
      color:rgba(60,40,140,.95);
    }
    .btn.good{
      border-color:rgba(22,163,74,.25);
      background:rgba(22,163,74,.10);
      color:rgba(22,163,74,.95);
    }

    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media (max-width:760px){
      .split{grid-template-columns:1fr}
      header{align-items:flex-start}
      .toolbar{justify-content:flex-start}
    }

    .col{
      background:linear-gradient(180deg, rgba(2,6,23,.030), rgba(2,6,23,.014));
      border:1px dashed rgba(2,6,23,.10);
      border-radius:16px; padding:10px;
      min-height:240px;
      position:relative;
    }
    .col::before{
      content:"";
      position:absolute; inset:8px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.55), transparent 55%);
      opacity:.35;
      pointer-events:none;
    }
    .col h3{margin:4px 6px 10px;font-size:13px;color:var(--muted);font-weight:950; position:relative}

    .item{
      width:100%; text-align:left;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:rgba(255,255,255,.94);
      border:1px solid rgba(15,23,42,.10); border-radius:14px;
      padding:10px 12px; margin:8px 4px; cursor:pointer;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
      transition:.15s;
      position:relative;
      z-index:1;
    }
    .item:hover{ transform: translateY(-1px); }
    .item small{color:var(--muted)}
    .item.selected{outline:2px solid rgba(124,58,237,.24); border-color:rgba(124,58,237,.24)}
    .item.correct{
      background:rgba(22,163,74,.08);
      border-color:rgba(22,163,74,.28);
    }
    .item.wrong{
      background:rgba(220,38,38,.06);
      border-color:rgba(220,38,38,.22);
    }

    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:10px}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#0b1220; color:#fff; padding:10px 12px; border-radius:999px;
      font-size:13px; opacity:0; pointer-events:none; transition:.2s;
      max-width:min(92vw,520px); text-align:center;
      box-shadow: 0 14px 34px rgba(2,6,23,.30);
      z-index:9999;
      white-space:pre-wrap;
    }
    .toast.show{opacity:1}

    .sentenceBox{
      border:1px solid rgba(15,23,42,.10);
      background:linear-gradient(180deg, rgba(2,6,23,.03), rgba(255,255,255,.92));
      border-radius:18px;
      padding:14px;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
    }
    .sentenceText{
      font-size:16px;
      font-weight:950;
      line-height:1.5;
      margin:0;
      word-break:break-word;
    }
    .blank{
      display:inline-block;
      padding:0 10px 2px;
      margin:0 2px;
      border-bottom:2px solid rgba(124,58,237,.60);
      color:rgba(60,40,140,.95);
      font-weight:950;
    }

    .choices{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .choice{
      border:1px solid rgba(15,23,42,.10); background:rgba(255,255,255,.94);
      padding:12px 12px; border-radius:14px; cursor:pointer; text-align:left;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
      transition:.15s;
    }
    .choice:hover{ transform: translateY(-1px); }
    .choice.correct{border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.08)}
    .choice.wrong{border-color:rgba(220,38,38,.28); background:rgba(220,38,38,.06)}

    /* ç¿»ç¿»å¡ */
    .flashWrap{display:flex;flex-direction:column;gap:10px}
    .flashCard{
      border:1px solid rgba(15,23,42,.10); border-radius:18px;
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow);
      padding:16px;
      min-height:240px;
      display:flex;flex-direction:column;justify-content:space-between;gap:12px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition:.15s;
      position:relative;
      overflow:hidden;
    }
    .flashCard::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(520px 180px at 10% 0%, rgba(124,58,237,.20), transparent 60%),
        radial-gradient(520px 180px at 95% 10%, rgba(6,182,212,.16), transparent 60%),
        radial-gradient(520px 180px at 50% 120%, rgba(236,72,153,.12), transparent 60%);
      filter: blur(10px);
      opacity:.55;
      pointer-events:none;
    }
    .flashCard:hover{ transform: translateY(-1px); }
    .flashTop{display:flex;align-items:center;justify-content:space-between;gap:8px; position:relative}
    .flashTag{font-size:12px;color:var(--muted)}
    .flashHint{font-size:12px;color:var(--muted)}
    .flashQ{font-size:18px;font-weight:950;line-height:1.25; position:relative}
    .flashA{
      font-size:18px;font-weight:950;line-height:1.25;
      color:rgba(22,163,74,.95);
      background:rgba(22,163,74,.06);
      border:1px solid rgba(22,163,74,.18);
      border-radius:14px;
      padding:12px 12px;
      display:none;
      position:relative;
    }
    .flashCard.showA .flashA{display:block;}
    .flashCard.showA .flashHint{color:rgba(22,163,74,.95);}

    /* æˆç¸¾å¡ Overlay */
    .overlay{
      position:fixed; inset:0;
      background:var(--overlay);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:10000;
    }
    .overlay.show{display:flex;}
    .scoreCard{
      width:min(900px, 96vw);
      border-radius:22px;
      background:
        radial-gradient(940px 280px at 14% 0%, rgba(124,58,237,.30), transparent 60%),
        radial-gradient(940px 280px at 92% 0%, rgba(6,182,212,.26), transparent 60%),
        radial-gradient(940px 280px at 55% 112%, rgba(236,72,153,.18), transparent 60%),
        rgba(255,255,255,.94);
      border:1px solid rgba(255,255,255,.38);
      box-shadow: 0 28px 68px rgba(2,6,23,.40);
      overflow:hidden;
      backdrop-filter: blur(16px);
      position:relative;
    }
    .scoreCard::after{
      content:"";
      position:absolute; inset:-2px;
      background: conic-gradient(from 180deg,
        rgba(124,58,237,.0),
        rgba(124,58,237,.28),
        rgba(6,182,212,.24),
        rgba(236,72,153,.20),
        rgba(245,158,11,.18),
        rgba(124,58,237,.0));
      filter: blur(12px);
      opacity:.42;
      pointer-events:none;
    }
    .scoreTop{
      padding:16px 16px 12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(2,6,23,.10);
      position:relative;
      z-index:1;
    }
    .scoreTop h2{
      margin:0;font-size:18px;font-weight:950;
      letter-spacing:.2px;
    }
    .scoreTop .time{
      font-size:12px;color:var(--muted);
      margin-top:6px;
    }
    .scoreBody{padding:14px 16px 16px; position:relative; z-index:1}
    .scoreGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:760px){ .scoreGrid{grid-template-columns:1fr} }
    .tile{
      border:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.88);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
    }
    .tile .k{font-size:12px;color:var(--muted);font-weight:900}
    .tile .v{font-size:18px;font-weight:950;margin-top:6px}

    .studentRow{
      display:grid;
      grid-template-columns: 1.2fr .8fr 1fr;
      gap:10px;
      margin:12px 0 6px;
      position:relative;
      z-index:1;
    }
    @media (max-width:760px){ .studentRow{grid-template-columns:1fr} }
    .field{
      border:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.88);
      border-radius:16px;
      padding:10px 12px;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin-bottom:6px;
    }
    .field input{
      width:100%;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.92);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
    }
    .field input:focus{
      border-color: rgba(124,58,237,.30);
      box-shadow: 0 0 0 4px rgba(124,58,237,.12);
    }

    .wrongList{
      margin-top:10px;
      border:1px solid rgba(2,6,23,.10);
      border-radius:16px;
      background:rgba(255,255,255,.88);
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
      position:relative;
      z-index:1;
    }
    .wrongList h3{
      margin:0;padding:10px 12px;
      font-size:12px;color:var(--muted);font-weight:950;
      border-bottom:1px solid rgba(2,6,23,.08);
    }
    .wrongList .items{
      max-height:220px; overflow:auto;
      padding:8px 12px 12px;
      font-size:13px; line-height:1.4;
      color:#1f2937;
    }
    .wrongItem{
      padding:8px 10px; border-radius:12px;
      background:rgba(2,6,23,.03);
      margin:8px 0;
      border:1px solid rgba(2,6,23,.06);
    }

    .scoreBtns{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:12px 16px 16px;
      border-top:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.80);
      position:relative;
      z-index:1;
    }

    /* ğŸ‰ Confetti layer */
    .confettiLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:20000;
      overflow:hidden;
      display:none;
    }
    .confettiLayer.show{display:block;}
    .confetti{
      position:absolute;
      top:-12px;
      width:10px;height:14px;
      border-radius:3px;
      opacity:.95;
      transform: translate3d(0,0,0) rotate(0deg);
      animation: fall linear forwards;
      will-change: transform, opacity;
      box-shadow: 0 12px 26px rgba(2,6,23,.15);
    }
    @keyframes fall{
      0%{
        transform: translate3d(var(--x,0px), -20px, 0) rotate(0deg);
        opacity: 1;
      }
      100%{
        transform: translate3d(calc(var(--x,0px) + var(--drift,0px)), calc(100vh + 40px), 0) rotate(var(--rot,540deg));
        opacity: .95;
      }
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>æ‡‰ç”¨æ–‡ï½œç¨±è¬‚ï¼†é¡Œè¾­ <span class="badge">ç·´ç¿’å¯è­‰æ˜</span></h1>
      <p>æ¯å›åˆå°‘é‡é¡Œç›®ï¼ˆé è¨­ 6 çµ„ï¼‰ï¼Œæ‰‹æ©Ÿå¥½æ“ä½œã€‚è¨ˆåˆ†æ¨¡å¼å®Œæˆå¾Œå¯ç”¢ç”Ÿæˆç¸¾å¡ï¼ˆå«å§“åæ¬„ã€éŒ¯é¡Œå›æ”¾ã€ç”¨æ™‚ä¸‹é™ï¼‹é”æ¨™å½©å¸¶ï¼‰ã€‚</p>
    </div>
    <div class="toolbar" id="modeBar">
      <button class="pill active" data-mode="match-letter">é…å°ï½œæ›¸ä¿¡</button>
      <button class="pill" data-mode="sentence">å¥å­å¡«ç©ºï¼ˆBï¼‰</button>
      <button class="pill" data-mode="match-couplet">é…å°ï½œé¡Œè¾­</button>
      <button class="pill" data-mode="flash">ç¿»ç¿»å¡</button>
      <button class="pill" data-mode="quiz">æƒ…å¢ƒ Quiz</button>
      <button class="pill ghost" id="scoreBtn" title="æŸ¥çœ‹/æˆªåœ–æˆç¸¾å¡">
        <span class="dot" id="scoreDot"></span>
        æˆç¸¾å¡
      </button>
    </div>
  </header>

  <section class="card">
    <div class="cardHead">
      <div>
        <div class="h" id="modeTitle">é…å°ï½œæ›¸ä¿¡ï¼ˆå°è±¡â†’ç”¨èªï¼‰</div>
        <div class="sub" id="modeSub">é»å·¦ä¸€å¼µ â†’ å†é»å³ä¸€å¼µé…å°ã€‚</div>
      </div>
      <div class="row">
        <button class="btn" id="resetBtn">é‡å‡ºæœ¬å›åˆ</button>
        <button class="btn primary" id="shuffleBtn">æ›ä¸€çµ„</button>
      </div>
    </div>
    <div class="cardBody" id="stage"></div>
  </section>
</div>

<div class="toast" id="toast"></div>

<!-- æˆç¸¾å¡ Overlay -->
<div class="overlay" id="overlay">
  <div class="scoreCard" id="scoreCard">
    <div class="scoreTop">
      <div>
        <h2>æˆç¸¾å¡ï½œæ‡‰ç”¨æ–‡ï¼ˆç¨±è¬‚ï¼†é¡Œè¾­ï¼‰</h2>
        <div class="time" id="scoreTime">â€”</div>
      </div>
      <div style="text-align:right">
        <div class="badge" id="scoreBadge">æœªé”æ¨™</div>
        <div class="time" id="scoreRule">ç¸½ç”¨æ™‚ä¸‹é™ï¼š60 ç§’</div>
      </div>
    </div>

    <div class="scoreBody">
      <div class="studentRow">
        <div class="field">
          <label>ç­ç´š</label>
          <input id="stuClass" placeholder="ä¾‹å¦‚ï¼šäºŒå•†ä¸€" />
        </div>
        <div class="field">
          <label>åº§è™Ÿ</label>
          <input id="stuNo" placeholder="ä¾‹å¦‚ï¼š12" inputmode="numeric" />
        </div>
        <div class="field">
          <label>å§“å</label>
          <input id="stuName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" />
        </div>
      </div>

      <div class="scoreGrid">
        <div class="tile">
          <div class="k">ç¸½æ­£ç¢ºç‡</div>
          <div class="v" id="scoreAcc">â€”</div>
        </div>
        <div class="tile">
          <div class="k">ç¸½ç”¨æ™‚ï¼ˆé¡¯ç¤ºå€¼ï¼‰</div>
          <div class="v" id="scoreDur">â€”</div>
        </div>
        <div class="tile">
          <div class="k">ä½œç­”ç¸½æ•¸ / æ­£ç¢º</div>
          <div class="v" id="scoreCount">â€”</div>
        </div>
        <div class="tile">
          <div class="k">å®Œæˆæ¨¡å¼ï¼ˆè¨ˆåˆ†ï¼‰</div>
          <div class="v" id="scoreModes">â€”</div>
        </div>
      </div>

      <div class="wrongList" id="wrongBox">
        <h3>éŒ¯é¡Œå›æ”¾ï¼ˆæœ¬æ¬¡æ‰€æœ‰è¨ˆåˆ†æ¨¡å¼ï¼‰</h3>
        <div class="items" id="wrongItems"></div>
      </div>
    </div>

    <div class="scoreBtns">
      <button class="btn primary" id="downloadBtn">ä¸‹è¼‰æˆç¸¾å¡ PNG</button>
      <button class="btn" id="closeBtn">é—œé–‰</button>
      <button class="btn good" id="clearBtn">æ¸…ç©ºæœ¬æ¬¡ç´€éŒ„</button>
    </div>
  </div>
</div>

<!-- ğŸ‰ å½©å¸¶ -->
<div class="confettiLayer" id="confettiLayer"></div>

<script>
/* =========================================================
   âœ… å¯èª¿æ•´åƒæ•¸
   ========================================================= */
const ROUND_SIZE_MATCH = 6;
const ROUND_SIZE_SENT  = 5;
const ROUND_SIZE_QUIZ  = 5;

const PASS_ACCURACY = 70.50;
const MIN_TOTAL_SECONDS = 60;

/* =========================================================
   å°å·¥å…·
   ========================================================= */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._id);
  toast._id = setTimeout(()=>t.classList.remove("show"), 1400);
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function sample(arr, n){ return shuffle(arr).slice(0, Math.min(n, arr.length)); }
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60);
  const s = sec%60;
  if(m<=0) return `${s}s`;
  return `${m}m ${String(s).padStart(2,"0")}s`;
}
function nowStamp(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

/* =========================================================
   âœ… DATAï¼ˆå«ä½ æçš„ã€Œç›´/æ©«å¼ã€æ”¹æˆåå‘é…å°ï¼Œé¿å…æç¤ºç­”æ¡ˆï¼‰
   ========================================================= */
const LETTER_CATEGORIES = [
  { cat:"å®¶çˆ¶ï¼å®¶åš´ï¼å®¶å›", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„çˆ¸çˆ¸ã€ï¼ˆå¥åœ¨ï¼‰"] },
  { cat:"å®¶æ¯ï¼å®¶æ…ˆ", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„åª½åª½ã€ï¼ˆå¥åœ¨ï¼‰"] },
  { cat:"å®¶å…„", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„å“¥å“¥ã€"] },
  { cat:"å®¶å§Š", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„å§å§ã€"] },
  { cat:"èˆå¼Ÿ", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„å¼Ÿå¼Ÿã€ï¼ˆå¥åœ¨ï¼‰"] },
  { cat:"èˆå¦¹", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„å¦¹å¦¹ã€ï¼ˆå¥åœ¨ï¼‰"] },
  { cat:"å°å…’ï¼å°çŠ¬", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„å…’å­ã€"] },
  { cat:"å°å¥³", prompts:["å°ä»–äººæåˆ°ã€Œæˆ‘çš„å¥³å…’ã€"] },

  { cat:"ä»¤å°Šï¼å°Šç¿", prompts:["æåˆ°å°æ–¹çš„çˆ¸çˆ¸ï¼ˆå°Šç¨±ï¼‰"] },
  { cat:"ä»¤å ‚ï¼å°Šå ‚ï¼è±å ‚", prompts:["æåˆ°å°æ–¹çš„åª½åª½ï¼ˆå°Šç¨±ï¼‰"] },
  { cat:"ä»¤éƒï¼ä»¤å…¬å­", prompts:["æåˆ°å°æ–¹çš„å…’å­ï¼ˆå°Šç¨±ï¼‰"] },
  { cat:"ä»¤å¬¡", prompts:["æåˆ°å°æ–¹çš„å¥³å…’ï¼ˆå°Šç¨±ï¼‰"] },

  { cat:"å…ˆçˆ¶ï¼å…ˆè€ƒï¼å…ˆåš´ï¼å…ˆå›", prompts:["å°ä»–äººæåˆ°ã€Œçˆ¸çˆ¸å·²é€ã€"] },
  { cat:"å…ˆæ¯ï¼å…ˆæ…ˆï¼å…ˆå¦£", prompts:["å°ä»–äººæåˆ°ã€Œåª½åª½å·²é€ã€"] },
  { cat:"äº¡å¼Ÿ", prompts:["å°ä»–äººæåˆ°ã€Œå¼Ÿå¼Ÿå·²é€ã€"] },
  { cat:"äº¡å¦¹", prompts:["å°ä»–äººæåˆ°ã€Œå¦¹å¦¹å·²é€ã€"] },

  { cat:"è³¢æ˜†ä»²", prompts:["ç¨±å°æ–¹å…„å¼Ÿï¼ˆå¹³è¼©å…„å¼Ÿï¼‰ç”¨èª"] },
  { cat:"è³¢ä¼‰å„·", prompts:["ç¨±å°æ–¹å¤«å¦»ï¼ˆå¤«å©¦ï¼‰ç”¨èª"] },
  { cat:"è³¢å–¬æ¢“", prompts:["ç¨±å°æ–¹çˆ¶å­ï¼ˆçˆ¶èˆ‡å­ï¼‰ç”¨èª"] },

  { cat:"éˆé‘’", prompts:["æç¨±èªï¼šå¯«çµ¦ä¸Šç´š/é•·å®˜ï¼ˆä¸€èˆ¬å…¬å‹™ï¼‰"] },
  { cat:"é“é‘’", prompts:["æç¨±èªï¼šå¯«çµ¦å®—æ•™ç•Œäººå£«/æ³•å¸«/é“é•·"] },
  { cat:"å°é‘’", prompts:["æç¨±èªï¼šå¯«çµ¦å¹³è¼©ï¼ˆä¸€èˆ¬æœ‹å‹/åŒå­¸ï¼‰"] },
  { cat:"æƒ é‘’", prompts:["æç¨±èªï¼šå¯«çµ¦å•†ç•Œ/å®¢æˆ¶/å¾€ä¾†å°è±¡ï¼ˆè¼ƒå®¢æ°£ï¼‰"] },
  { cat:"å¤§é‘’", prompts:["æç¨±èªï¼šå¯«çµ¦é•·è¼©ï¼ˆè¼ƒå°Šæ•¬ï¼‰"] },

  { cat:"éˆå•Ÿ", prompts:["å•Ÿå°è©ï¼šå¯„çµ¦æ ¡é•·/ä¸»ç®¡/é•·å®˜ï¼ˆå…¬å‹™ï¼‰"] },
  { cat:"ç¦å•Ÿ", prompts:["å•Ÿå°è©ï¼šå¯„çµ¦çˆ¶æ¯/å®¶ä¸­é•·è¼©ï¼ˆå®¶æ›¸ï¼‰"] },
  { cat:"å°å•Ÿ", prompts:["å•Ÿå°è©ï¼šå¯„çµ¦å¹³è¼©æœ‹å‹/åŒå­¸"] },
  { cat:"é“å•Ÿ", prompts:["å•Ÿå°è©ï¼šå¯„çµ¦å®—æ•™ç•Œäººå£«"] },
  { cat:"éˆå‰", prompts:["å¼”å”ä¿¡å°ï¼šå¯„çµ¦å–ªå®¶ï¼ˆå¯«åœ¨æ”¶ä»¶äººå¾Œ/æˆ–ä¿¡å°ä¸Šï¼‰"] },

  { cat:"ç·˜ï¼è¬¹ç·˜", prompts:["ç·˜å°è©ï¼šå¯«çµ¦å¹³è¼©/æ™šè¼©å¯„å‡ºå‰å°ç·˜"] },

  { cat:"æ•¬è«‹ éˆå®‰", prompts:["å•å€™èªï¼šå¯«çµ¦ä¸Šç´š/é•·å®˜ï¼ˆå…¬å‹™ä¿¡ï¼‰"] },
  { cat:"æ•¬è«‹ å¤§å®‰", prompts:["å•å€™èªï¼šå¯«çµ¦é•·è¼©ï¼ˆä¸€èˆ¬é•·è¼©ï¼‰"] },
  { cat:"é †é Œ æ™‚ç¥º", prompts:["å•å€™èªï¼šå¯«çµ¦å¹³è¼©ï¼ˆä¸€èˆ¬ç¤¾äº¤ï¼‰"] },
  { cat:"æ­¤è‡´ æ•¬ç¦®", prompts:["çµå°¾ç¦®è²Œèªï¼šä¸€èˆ¬å…¬æ–‡/æ›¸ä¿¡å¸¸ç”¨"] },

  /* âœ… åå‘ï¼šé¡Œå¹¹ä¸ç›´æ¥èªªã€Œæ©«å¼/ç›´å¼ã€ */
  { cat:"ç›´å¼ä¿¡å°", prompts:["æ”¶ä»¶äººæ¬„ä½ç”±å³ä¸Šå¾€ä¸‹å¯«ï¼ˆæ˜¯å“ªä¸€ç¨®ä¿¡å°æ ¼å¼ï¼Ÿï¼‰"] },
  { cat:"æ©«å¼ä¿¡å°", prompts:["æ”¶ä»¶äººæ¬„ä½ç”±å·¦è‡³å³å¯«ï¼ˆæ˜¯å“ªä¸€ç¨®ä¿¡å°æ ¼å¼ï¼Ÿï¼‰"] },
];

const COUPLET_CATEGORIES = [
  { cat:"è³€è¨‚å©š", phrases:["ç™½é¦–æˆç´„","æ–‡å®šå‰ç¥¥","ç·£è¨‚ä¸‰ç”Ÿ"] },
  { cat:"è³€çµå©š", phrases:["ç™¾å¹´å¥½åˆ","ç è¯ç’§åˆ","é¸é³³å’Œé³´"] },
  { cat:"è³€å«å¥³", phrases:["ä¹‹å­äºæ­¸","äºæ­¸èªŒå–œ","é³³ç¿¥é¸ç¿”"] },
  { cat:"è³€ç”Ÿå­", phrases:["ç†Šå¤¢å¾µç¥¥","å¼„ç’‹èªŒå–œ","éºŸè¶¾å‘ˆç¥¥"] },
  { cat:"è³€ç”Ÿå¥³", phrases:["æ˜ç å…¥æŒ","å¼„ç“¦èªŒå–œ","å½©å ‚æ·»å–œ"] },
  { cat:"è³€é·å±…", phrases:["é¶¯é·å–¬æœ¨","å–¬é·èªŒæ…¶","æ–°å±…èªŒå–œ"] },
  { cat:"è³€é–‹å¹•", phrases:["é–‹å¹•èªŒæ…¶","å®åœ–å¤§å±•","ç››æœƒéš†é–‹"] },
  { cat:"è³€å‡é·", phrases:["æ­¥æ­¥é«˜é™","é’é›²ç›´ä¸Š","æ¦®è†ºæ–°è·"] },
  { cat:"è³€ç•¢æ¥­", phrases:["éµ¬ç¨‹è¬é‡Œ","å‰ç¨‹ä¼¼éŒ¦","å±•ç¿…é«˜é£›"] },
  { cat:"è¼“å¸«é•·", phrases:["æ•™æ¾¤é•·æ˜­","å¾·æ¥­æ°¸æ‡·","æ‡¿å¾·é•·æ˜­"] },
];

/* =========================================================
   âœ… å¥å­å¡«ç©ºï¼ˆBï¼‰ï¼š
   - ç¬¬ 1 é¡Œæ”¹æˆã€Œå¯«çµ¦æ ¡é•·/ä¸»ç®¡çš„è‡´è¬ä¿¡ã€â†’ ä¸å†è®“ä»¤å°Šç”¢ç”Ÿæ­§ç¾©
   ========================================================= */
const SENTENCE_BANK = [
  {
    text:"ï¼ˆå¯«çµ¦æ ¡é•·/ä¸»ç®¡çš„è‡´è¬ä¿¡ï¼‰<br>æ•¬å•Ÿè€…ï¼šæ—¥å‰æ‰¿è’™<span class='blank'>ï¼¿ï¼¿ï¼¿</span>æ•™èª¨ï¼Œå—ç›Šè‰¯å¤šï¼Œç‰¹æ­¤è‡´è¬ã€‚",
    choices:["å®¶çˆ¶","ä»¤å°Š","éˆåº§","èˆå¼Ÿ"],
    answer:2,
    explain:"æ­¤é¡Œå·²é™å®šã€Œå¯«çµ¦æ ¡é•·/ä¸»ç®¡ã€ï¼Œç”¨æ•¬ç¨±ã€Œéˆåº§ã€æœ€åˆå®œï¼›ã€Œä»¤å°Šã€æ˜¯å°æ–¹çˆ¶è¦ªï¼Œèªå¢ƒä¸ç¬¦ã€‚"
  },
  {
    text:"è¬¹ä»£<span class='blank'>ï¼¿ï¼¿ï¼¿</span>è‡´ä¸Šèª æ‘¯å•å€™ï¼Œä¸¦ç¥è¿‘å®‰ã€‚",
    choices:["å®¶æ¯","ä»¤å ‚","äº¡æ¯","å°Šå ‚"],
    answer:0,
    explain:"ã€Œè¬¹ä»£â€¦è‡´æ„ã€å¤šä»£è‡ªå·±å®¶äººï¼ˆå®¶æ¯/å®¶çˆ¶ï¼‰ã€‚"
  },
  {
    text:"ä½ è¦å¯„ä¿¡å›å®¶çµ¦çˆ¶æ¯ï¼Œä¿¡å°å•Ÿå°è©å®œå¯«<span class='blank'>ï¼¿ï¼¿ï¼¿</span>ã€‚",
    choices:["ç¦å•Ÿ","ç·˜","é“å•Ÿ","éˆå•Ÿ"],
    answer:0,
    explain:"å¯„çµ¦çˆ¶æ¯å¸¸ç”¨ã€Œç¦å•Ÿã€ã€‚"
  },
  {
    text:"ä½ è¦å¯«ä¿¡çµ¦ä¸Šç´šä¸»ç®¡ï¼Œä¿¡å°å•Ÿå°è©å®œå¯«<span class='blank'>ï¼¿ï¼¿ï¼¿</span>ã€‚",
    choices:["ç¦å•Ÿ","å°å•Ÿ","éˆå•Ÿ","é“å•Ÿ"],
    answer:2,
    explain:"å¯„çµ¦é•·å®˜å¸¸ç”¨ã€Œéˆå•Ÿã€ã€‚"
  },
  {
    text:"å¼”å”ä¿¡å°å¸¸è¦‹å¯«æ³•ï¼šåœ¨æ”¶ä»¶äººå¾Œå¯åŠ è¨»<span class='blank'>ï¼¿ï¼¿ï¼¿</span>ã€‚",
    choices:["ç¦å•Ÿ","éˆå‰","æ•¬å•Ÿ","ç·˜å°"],
    answer:1,
    explain:"å¼”å”å¯ç”¨ã€Œéˆå‰ã€ç­‰æ¨™è¨˜ã€‚"
  },
];

const QUIZ_BANK = [
  {
    tag:"é¡Œè¾­",
    scenarioQ:"æœ‹å‹æ¬æ–°å®¶ï¼Œä½ è¦å¯«é¡Œè¾­ï¼Œè¼ƒåˆå®œçš„æ˜¯ï¼Ÿ",
    choices:["é¶¯é·å–¬æœ¨","ç™¾å¹´å¥½åˆ","å¼„ç’‹èªŒå–œ","æ­¥æ­¥é«˜é™"],
    answer:0,
    explain:"é·å±…å¸¸ç”¨ã€Œé¶¯é·å–¬æœ¨ï¼å–¬é·èªŒæ…¶ã€ã€‚"
  },
  {
    tag:"é¡Œè¾­",
    scenarioQ:"æœ‹å‹å®¶è¦å«å¥³å…’ï¼Œç´…åŒ…è¢‹é¡Œè¾­è¼ƒåˆå®œçš„æ˜¯ï¼Ÿ",
    choices:["ä¹‹å­äºæ­¸","éµ¬ç¨‹è¬é‡Œ","æ•™æ¾¤é•·æ˜­","ç†Šå¤¢å¾µç¥¥"],
    answer:0,
    explain:"å«å¥³å¸¸ç”¨ã€Œä¹‹å­äºæ­¸ï¼äºæ­¸èªŒå–œã€ã€‚"
  },
  {
    tag:"æ›¸ä¿¡",
    scenarioQ:"ä½ è¦ç¨±å‘¼å°æ–¹å¤«å¦»ï¼ˆå¤«å©¦ï¼‰åˆç¨±ï¼Œè¼ƒåˆå®œçš„æ˜¯ï¼Ÿ",
    choices:["è³¢æ˜†ä»²","è³¢ä¼‰å„·","è³¢å–¬æ¢“","è³¢å‹"],
    answer:1,
    explain:"å¤«å©¦åˆç¨±å¸¸ç”¨ã€Œè³¢ä¼‰å„·ã€ã€‚"
  },
  {
    tag:"æ›¸ä¿¡",
    scenarioQ:"ä½ è¦å¯«ä¿¡çµ¦å®—æ•™ç•Œäººå£«ï¼Œæç¨±èªè¼ƒåˆå®œçš„æ˜¯ï¼Ÿ",
    choices:["éˆé‘’","é“é‘’","å°é‘’","æƒ é‘’"],
    answer:1,
    explain:"å®—æ•™ç•Œå¸¸ç”¨ã€Œé“é‘’ã€ã€‚"
  },
  {
    tag:"æ›¸ä¿¡",
    scenarioQ:"ä½ è¦å¯«çµ¦ä¸Šç´šä¸»ç®¡ï¼Œå•å€™èªè¼ƒåˆå®œçš„æ˜¯ï¼Ÿ",
    choices:["é †é Œ æ™‚ç¥º","æ•¬è«‹ éˆå®‰","æ•¬è«‹ å¤§å®‰","æ­¤è‡´ æ•¬ç¦®"],
    answer:1,
    explain:"ä¸Šç´š/é•·å®˜å¤šç”¨ã€Œæ•¬è«‹ éˆå®‰ã€ã€‚"
  },
];

/* =========================================================
   å›åˆé¡Œåº«ç”Ÿæˆï¼šæŠ½é¡åˆ¥ â†’ å³å´ä¸é‡è¤‡ â†’ ä¸€å°ä¸€
   ========================================================= */
function buildLetterPairs(roundN){
  const cats = sample(LETTER_CATEGORIES, Math.min(roundN, LETTER_CATEGORIES.length));
  return cats.map(c => ({ left: sample(c.prompts, 1)[0], right: c.cat }));
}
function buildCoupletPairs(roundN){
  const cats = sample(COUPLET_CATEGORIES, Math.min(roundN, COUPLET_CATEGORIES.length));
  return cats.map(c => ({ left: sample(c.phrases, 1)[0], right: c.cat }));
}

/* =========================================================
   æˆç¸¾ç´€éŒ„
   ========================================================= */
const grade = {
  startedAt: Date.now(),
  attempts: 0,
  correct: 0,
  completedModes: new Set(),
  wrongs: [],
};

function markAttempt(isCorrect){
  grade.attempts++;
  if(isCorrect) grade.correct++;
}
function addWrong(mode, q, correct, picked){
  grade.wrongs.push({mode, q, correct, picked});
}
function accuracy(){
  if(grade.attempts<=0) return 0;
  return (grade.correct/grade.attempts)*100;
}
function displayDurationSec(){
  const sec = (Date.now() - grade.startedAt)/1000;
  return Math.max(sec, MIN_TOTAL_SECONDS);
}
function scoreDotUpdate(){
  const acc = accuracy();
  const dot = $("#scoreDot");
  if(grade.attempts===0){ dot.className="dot"; return; }
  dot.className = "dot " + (acc>=PASS_ACCURACY ? "good" : "warn");
}

/* =========================================================
   ğŸ‰ Confettiï¼ˆé”æ¨™å¾Œå™´ä¸€æ¬¡ï¼‰
   ========================================================= */
let confettiLock = false;
function launchConfetti(){
  if(confettiLock) return;
  confettiLock = true;

  const layer = $("#confettiLayer");
  layer.innerHTML = "";
  layer.classList.add("show");

  const colors = ["#7c3aed","#06b6d4","#ec4899","#f59e0b","#22c55e","#ffffff"];
  const count = Math.min(120, Math.floor(window.innerWidth/6)); // æ‰‹æ©Ÿä¹Ÿä¸æœƒå¤ªçˆ†

  for(let i=0;i<count;i++){
    const c = document.createElement("div");
    c.className = "confetti";
    const x = Math.random() * window.innerWidth;
    const drift = (Math.random()*2-1) * 220;
    const dur = 1.9 + Math.random()*1.6;
    const rot = 360 + Math.random()*720;
    const w = 7 + Math.random()*8;
    const h = 10 + Math.random()*10;

    c.style.left = x + "px";
    c.style.width = w + "px";
    c.style.height = h + "px";
    c.style.background = colors[Math.floor(Math.random()*colors.length)];
    c.style.animationDuration = dur + "s";
    c.style.setProperty("--x", "0px");
    c.style.setProperty("--drift", drift + "px");
    c.style.setProperty("--rot", rot + "deg");
    c.style.animationDelay = (Math.random()*0.15) + "s";

    layer.appendChild(c);
  }

  setTimeout(()=>{
    layer.classList.remove("show");
    layer.innerHTML = "";
    confettiLock = false;
  }, 2600);
}

/* =========================================================
   æ¨¡å¼
   ========================================================= */
const MODES = {
  "match-letter": { title:"é…å°ï½œæ›¸ä¿¡ï¼ˆå°è±¡â†’ç”¨èªï¼‰", sub:"é»å·¦ä¸€å¼µ â†’ å†é»å³ä¸€å¼µé…å°ã€‚å³å´ç­”æ¡ˆä¸é‡è¤‡ï¼Œä¸€å°ä¸€ã€‚", kind:"match", source:"letter",
                    leftLabel:"å·¦ï½œæƒ…å¢ƒ / å°è±¡", rightLabel:"å³ï½œæ­£ç¢ºç”¨èª", graded:true },
  "sentence":     { title:"å¥å­å¡«ç©ºï¼ˆBï¼‰ï½œæ›¸ä¿¡èªå¢ƒåˆ¤æ–·", sub:"ä¸€é¡Œä¸€å±ï¼šçœ‹å¥å­ï¼Œå†é¸æœ€åˆå®œç”¨èªã€‚", kind:"sentence", graded:true },
  "match-couplet":{ title:"é…å°ï½œé¡Œè¾­ï¼ˆé¡Œè¾­â†’é¡åˆ¥ï¼‰", sub:"æ¯å›åˆæŠ½ä¸åŒé¡åˆ¥ï¼šå³å´ä¸é‡è¤‡ï¼Œä¸€å°ä¸€ã€‚", kind:"match", source:"couplet",
                    leftLabel:"å·¦ï½œé¡Œè¾­", rightLabel:"å³ï½œé¡åˆ¥", graded:true },
  "flash":        { title:"ç¿»ç¿»å¡ï½œå¿«åˆ·è¤‡ç¿’", sub:"é»å¡ç‰‡æˆ–æŒ‰ç¿»é¢ã€‚å…ˆæƒ³ 3 ç§’å†ç¿»é¢ã€‚", kind:"flash", graded:false },
  "quiz":         { title:"æƒ…å¢ƒ Quizï½œé¸é¡Œè¾­/ç¨±è¬‚", sub:"5 é¡Œç®— 1 å›åˆï¼›å…ˆé¸ï¼Œå†çœ‹è§£æã€‚", kind:"quiz", graded:true },
};

const state = {
  mode:"match-letter",
  roundPairs:[],
  left:[],
  right:[],
  pickedLeft:null,
  pickedRight:null,
  locked:new Set(),
  score:0,
  total:0,

  quizIdxs:[],
  quizPos:0,
  quizAnswered:false,
  quizCorrect:0,

  sentRound:[],
  sentPos:0,
  sentAnswered:false,
  sentCorrect:0,

  flashDeck:[],
  flashPos:0,
  flashShow:false,
};

function setMode(mode){
  state.mode = mode;
  $$("#modeBar .pill").forEach(b=>b.classList.toggle("active", b.dataset.mode===mode));
  $("#modeTitle").textContent = MODES[mode].title;
  $("#modeSub").textContent = MODES[mode].sub;
  build();
}

function build(){
  const stage = $("#stage");
  stage.innerHTML = "";
  const m = MODES[state.mode];

  if(m.kind==="match"){
    const pairs = (m.source==="couplet")
      ? buildCoupletPairs(ROUND_SIZE_MATCH)
      : buildLetterPairs(ROUND_SIZE_MATCH);
    return buildMatch(stage, pairs, m.leftLabel, m.rightLabel, m.graded);
  }
  if(m.kind==="sentence") return buildSentence(stage);
  if(m.kind==="quiz") return buildQuiz(stage);
  if(m.kind==="flash") return buildFlash(stage);
}

/* =========================================================
   MATCH
   ========================================================= */
function buildMatch(stage, pairs, leftLabel, rightLabel, graded){
  state.roundPairs = pairs;
  state.left  = state.roundPairs.map((p, i)=>({ key:"L"+i, text:p.left }));
  state.right = shuffle(state.roundPairs.map((p, i)=>({ key:"R"+i, text:p.right })));

  state.pickedLeft = null;
  state.pickedRight = null;
  state.locked = new Set();
  state.score = 0;
  state.total = state.roundPairs.length;

  const wrap = document.createElement("div");
  wrap.className = "split";

  const colL = document.createElement("div");
  colL.className = "col";
  colL.innerHTML = `<h3>${escapeHtml(leftLabel || "å·¦")}</h3>`;

  const colR = document.createElement("div");
  colR.className = "col";
  colR.innerHTML = `<h3>${escapeHtml(rightLabel || "å³")}</h3>`;

  state.left.forEach(it=>colL.appendChild(renderItem(it, "left", graded)));
  state.right.forEach(it=>colR.appendChild(renderItem(it, "right", graded)));

  wrap.appendChild(colL);
  wrap.appendChild(colR);

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.id = "matchMeta";
  meta.textContent = `æœ¬å›åˆï¼š${state.total} çµ„ï½œå·²å®Œæˆï¼š0/${state.total}`;

  stage.appendChild(wrap);
  stage.appendChild(meta);

  function renderItem(item, side, graded){
    const btn = document.createElement("button");
    btn.className = "item";
    btn.dataset.side = side;
    btn.dataset.key = item.key;
    btn.innerHTML = `<span>${escapeHtml(item.text)}</span><small>é»é¸</small>`;

    btn.addEventListener("click", ()=>{
      if(state.locked.has(item.key)) return;
      btn.classList.remove("wrong");

      if(side === "left"){
        $$(".item[data-side='left']").forEach(x=>x.classList.remove("selected"));
        state.pickedLeft = item.key;
        btn.classList.add("selected");
      }else{
        $$(".item[data-side='right']").forEach(x=>x.classList.remove("selected"));
        state.pickedRight = item.key;
        btn.classList.add("selected");
      }
      if(state.pickedLeft && state.pickedRight) checkMatch(graded);
    });

    return btn;
  }

  function checkMatch(graded){
    const Lidx = Number(state.pickedLeft.slice(1));
    const correctRightKey = "R"+Lidx;

    const leftBtn = $(`.item[data-key="${state.pickedLeft}"]`);
    const rightBtn = $(`.item[data-key="${state.pickedRight}"]`);

    const qText = state.roundPairs[Lidx].left;
    const correctText = state.roundPairs[Lidx].right;
    const pickedText = state.right[Number(state.pickedRight.slice(1))]?.text || rightBtn?.innerText || "";

    if(state.pickedRight === correctRightKey){
      state.locked.add(state.pickedLeft);
      state.locked.add(state.pickedRight);
      leftBtn.classList.remove("selected");
      rightBtn.classList.remove("selected");
      leftBtn.classList.add("correct");
      rightBtn.classList.add("correct");
      leftBtn.querySelector("small").textContent = "âœ…";
      rightBtn.querySelector("small").textContent = "âœ…";
      state.score++;

      if(graded){
        markAttempt(true);
        scoreDotUpdate();
      }
      toast("é…å°æ­£ç¢º âœ…");
    }else{
      rightBtn.classList.remove("selected");
      rightBtn.classList.add("wrong");

      if(graded){
        markAttempt(false);
        addWrong(MODES[state.mode].title, qText, correctText, pickedText);
        scoreDotUpdate();
      }
      toast("å†æƒ³ä¸€ä¸‹ï½ (Â´ãƒ»Ï‰ãƒ»`)");
    }

    state.pickedLeft = null;
    state.pickedRight = null;

    const meta = $("#matchMeta");
    if(meta) meta.textContent = `æœ¬å›åˆï¼š${state.total} çµ„ï½œå·²å®Œæˆï¼š${state.score}/${state.total}`;

    if(state.score === state.total){
      if(graded) grade.completedModes.add(MODES[state.mode].title);
      toast("æœ¬å›åˆå®Œæˆ âœ¨");
    }
  }
}

/* =========================================================
   SENTENCE
   ========================================================= */
function buildSentence(stage){
  state.sentRound = sample(SENTENCE_BANK, ROUND_SIZE_SENT);
  state.sentPos = 0;
  state.sentAnswered = false;
  state.sentCorrect = 0;

  stage.innerHTML = `
    <div class="row">
      <button class="btn" id="sentPrev">ä¸Šä¸€é¡Œ</button>
      <button class="btn primary" id="sentNext">ä¸‹ä¸€é¡Œ</button>
    </div>
    <div style="margin-top:12px" id="sentArea"></div>
  `;

  const render = ()=>{
    state.sentAnswered = false;
    const q = state.sentRound[state.sentPos];

    $("#sentArea").innerHTML = `
      <div class="meta">å¥å­å¡«ç©ºï½œç¬¬ ${state.sentPos+1}/${state.sentRound.length} é¡Œï½œç›®å‰ï¼š${state.sentCorrect}/${state.sentPos}</div>
      <div class="sentenceBox">
        <p class="sentenceText">${q.text}</p>
      </div>
      <div class="choices" id="sentChoices"></div>
      <div class="meta" id="sentMeta">å…ˆé¸ï¼Œå†çœ‹è§£æã€‚</div>
    `;

    const ch = $("#sentChoices");
    q.choices.forEach((c, idx)=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.textContent = c;
      b.onclick = ()=>{
        if(state.sentAnswered) return;
        state.sentAnswered = true;

        [...ch.children].forEach((node, j)=>{
          node.classList.remove("correct","wrong");
          if(j === q.answer) node.classList.add("correct");
        });

        const correct = (idx === q.answer);
        if(!correct) b.classList.add("wrong");

        $("#sentMeta").textContent = "è§£æï¼š" + (q.explain || "ï¼ˆç•¥ï¼‰");

        markAttempt(correct);
        if(!correct){
          addWrong(MODES[state.mode].title, q.text.replaceAll(/<[^>]*>/g,""), q.choices[q.answer], c);
        }
        scoreDotUpdate();

        if(correct){ state.sentCorrect++; toast("æ­£ç¢º âœ…"); }
        else toast("å†çœ‹è§£æï½ ãˆã£ã¨");
      };
      ch.appendChild(b);
    });
  };

  $("#sentPrev").onclick = ()=>{
    state.sentPos = (state.sentPos - 1 + state.sentRound.length) % state.sentRound.length;
    render();
  };
  $("#sentNext").onclick = ()=>{
    if(!state.sentAnswered){ toast("å…ˆä½œç­”å†æ›é¡Œæ¯”è¼ƒæœ‰æ•ˆå–”"); return; }
    if(state.sentPos === state.sentRound.length-1){
      grade.completedModes.add(MODES[state.mode].title);
    }
    state.sentPos = (state.sentPos + 1) % state.sentRound.length;
    render();
  };

  render();
}

/* =========================================================
   QUIZ
   ========================================================= */
function buildQuiz(stage){
  const idxs = shuffle(QUIZ_BANK.map((_,i)=>i)).slice(0, ROUND_SIZE_QUIZ);
  state.quizIdxs = idxs;
  state.quizPos = 0;
  state.quizAnswered = false;
  state.quizCorrect = 0;

  stage.innerHTML = `
    <div class="row">
      <button class="btn" id="quizPrev">ä¸Šä¸€é¡Œ</button>
      <button class="btn primary" id="quizNext">ä¸‹ä¸€é¡Œ</button>
    </div>
    <div style="margin-top:12px" id="quizArea"></div>
  `;

  const render = ()=>{
    state.quizAnswered = false;
    const q = QUIZ_BANK[state.quizIdxs[state.quizPos]];

    $("#quizArea").innerHTML = `
      <div class="meta">${q.tag}ï½œç¬¬ ${state.quizPos+1}/${state.quizIdxs.length} é¡Œï½œç›®å‰ï¼š${state.quizCorrect}/${state.quizPos}</div>
      <div class="sentenceBox">
        <p class="sentenceText">${escapeHtml(q.scenarioQ)}</p>
      </div>
      <div class="choices" id="quizChoices"></div>
      <div class="meta" id="quizMeta">è«‹é¸æœ€åˆå®œçš„é¡Œè¾­/ç”¨èªã€‚</div>
    `;

    const ch = $("#quizChoices");
    q.choices.forEach((c, idx)=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.textContent = c;
      b.onclick = ()=>{
        if(state.quizAnswered) return;
        state.quizAnswered = true;

        [...ch.children].forEach((node, j)=>{
          node.classList.remove("correct","wrong");
          if(j === q.answer) node.classList.add("correct");
        });

        const correct = (idx === q.answer);
        if(!correct) b.classList.add("wrong");

        $("#quizMeta").textContent = "è§£æï¼š" + (q.explain || "ï¼ˆç•¥ï¼‰");

        markAttempt(correct);
        if(!correct){
          addWrong(MODES[state.mode].title, q.scenarioQ, q.choices[q.answer], c);
        }
        scoreDotUpdate();

        if(correct){ state.quizCorrect++; toast("ç­”å° âœ…"); }
        else toast("å†æƒ³ä¸€ä¸‹ï½ (à¸‡ â€¢Ì€_â€¢Ì)à¸‡");
      };
      ch.appendChild(b);
    });
  };

  $("#quizPrev").onclick = ()=>{
    state.quizPos = (state.quizPos - 1 + state.quizIdxs.length) % state.quizIdxs.length;
    render();
  };
  $("#quizNext").onclick = ()=>{
    if(!state.quizAnswered){ toast("å…ˆä½œç­”å†æ›é¡Œæ¯”è¼ƒæœ‰æ•ˆå–”"); return; }
    if(state.quizPos === state.quizIdxs.length-1){
      grade.completedModes.add(MODES[state.mode].title);
    }
    state.quizPos = (state.quizPos + 1) % state.quizIdxs.length;
    render();
  };

  render();
}

/* =========================================================
   FLASHï¼ˆä¸è¨ˆåˆ†ï¼‰
   ========================================================= */
function buildFlash(stage){
  const deck = [];
  LETTER_CATEGORIES.forEach(c=>c.prompts.forEach(p=>deck.push({ tag:"æ›¸ä¿¡", q:p, a:c.cat })));
  COUPLET_CATEGORIES.forEach(c=>c.phrases.forEach(ph=>deck.push({ tag:"é¡Œè¾­", q:`é¡Œè¾­ï¼š${ph}`, a:`é¡åˆ¥ï¼š${c.cat}` })));

  state.flashDeck = shuffle(deck).slice(0, 14);
  state.flashPos = 0;
  state.flashShow = false;

  stage.innerHTML = `
    <div class="flashWrap">
      <div class="flashCard" id="flashCard" role="button" aria-label="ç¿»ç¿»å¡"></div>
      <div class="row">
        <button class="btn primary" id="flipBtn">ç¿»é¢</button>
        <button class="btn" id="prevBtn">ä¸Šä¸€å¼µ</button>
        <button class="btn" id="nextBtn">ä¸‹ä¸€å¼µ</button>
      </div>
      <div class="meta" id="flashMeta"></div>
    </div>
  `;

  const render = ()=>{
    const card = $("#flashCard");
    const meta = $("#flashMeta");
    const cur = state.flashDeck[state.flashPos];

    card.innerHTML = `
      <div class="flashTop">
        <div class="flashTag">${escapeHtml(cur.tag)}ï½œç¬¬ ${state.flashPos+1}/${state.flashDeck.length} å¼µ</div>
        <div class="flashHint">${state.flashShow ? "ç­”æ¡ˆ" : "å…ˆæƒ³ 3 ç§’å†ç¿» (é»å¡ç‰‡/æŒ‰ç¿»é¢)"}</div>
      </div>
      <div class="flashQ">${escapeHtml(cur.q)}</div>
      <div class="flashA">${escapeHtml(cur.a)}</div>
    `;
    card.classList.toggle("showA", state.flashShow);
    meta.textContent = "ç¿»ç¿»å¡ä¸è¨ˆå…¥æˆç¸¾å¡ï¼ˆæš–èº«/è¤‡ç¿’ç”¨ï¼‰ã€‚";
  };

  const flip = ()=>{
    state.flashShow = !state.flashShow;
    render();
  };

  $("#flipBtn").onclick = flip;
  $("#flashCard").onclick = flip;
  $("#prevBtn").onclick = ()=>{
    state.flashPos = (state.flashPos - 1 + state.flashDeck.length) % state.flashDeck.length;
    state.flashShow = false;
    render();
  };
  $("#nextBtn").onclick = ()=>{
    state.flashPos = (state.flashPos + 1) % state.flashDeck.length;
    state.flashShow = false;
    render();
  };

  render();
}

/* =========================================================
   âœ… æˆç¸¾å¡ï¼šå­¸ç”Ÿæ¬„ä½ï¼ˆlocalStorageï¼‰
   ========================================================= */
const LS_KEY = "appliedWriting_studentInfo_v2";
function loadStudentInfo(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj.cls) $("#stuClass").value = obj.cls;
    if(obj.no)  $("#stuNo").value = obj.no;
    if(obj.name)$("#stuName").value = obj.name;
  }catch(e){}
}
function saveStudentInfo(){
  const obj = {
    cls: ($("#stuClass").value || "").trim(),
    no:  ($("#stuNo").value || "").trim(),
    name:($("#stuName").value || "").trim(),
  };
  localStorage.setItem(LS_KEY, JSON.stringify(obj));
}
["stuClass","stuNo","stuName"].forEach(id=>{
  $("#"+id).addEventListener("input", saveStudentInfo);
});

/* =========================================================
   æˆç¸¾å¡
   ========================================================= */
function openScore(){
  scoreDotUpdate();

  const acc = accuracy();
  const dur = displayDurationSec();
  const pass = acc >= PASS_ACCURACY && grade.attempts>0;

  $("#scoreTime").textContent = `æ™‚é–“ï¼š${nowStamp()}`;
  $("#scoreAcc").textContent = `${acc.toFixed(2)}%`;
  $("#scoreDur").textContent = fmtTime(dur);
  $("#scoreCount").textContent = `${grade.attempts} / ${grade.correct}`;
  $("#scoreModes").textContent = grade.completedModes.size ? [...grade.completedModes].join("ã€") : "ï¼ˆå°šæœªå®Œæˆè¨ˆåˆ†æ¨¡å¼ï¼‰";

  $("#scoreBadge").textContent = pass ? "é”æ¨™ ğŸ‰" : "æœªé”æ¨™";
  $("#scoreBadge").style.borderColor = pass ? "rgba(22,163,74,.25)" : "rgba(245,158,11,.25)";
  $("#scoreBadge").style.background = pass ? "rgba(22,163,74,.10)" : "rgba(245,158,11,.10)";
  $("#scoreBadge").style.color = pass ? "rgba(22,163,74,.95)" : "rgba(161,98,7,.95)";

  const box = $("#wrongItems");
  box.innerHTML = "";
  if(grade.wrongs.length===0){
    box.innerHTML = `<div class="wrongItem">ï¼ˆæœ¬æ¬¡æ²’æœ‰è¨˜éŒ„åˆ°éŒ¯é¡Œï¼‰</div>`;
  }else{
    grade.wrongs.slice(-60).forEach(w=>{
      const div = document.createElement("div");
      div.className = "wrongItem";
      div.innerHTML = `
        <div style="font-weight:950; margin-bottom:6px;">${escapeHtml(w.mode)}</div>
        <div style="color:#111827; margin-bottom:6px;">Qï¼š${escapeHtml(w.q)}</div>
        <div style="color: var(--good); font-weight:900;">æ­£è§£ï¼š${escapeHtml(w.correct)}</div>
        <div style="color: var(--bad); font-weight:900;">ä½ çš„é¸æ“‡ï¼š${escapeHtml(w.picked)}</div>
      `;
      box.appendChild(div);
    });
  }

  $("#overlay").classList.add("show");

  /* âœ… é”æ¨™å™´å½©å¸¶ï¼ˆæ‰“é–‹æˆç¸¾å¡æ™‚è§¸ç™¼ä¸€æ¬¡ï¼‰ */
  if(pass){
    launchConfetti();
  }
}

function closeScore(){
  $("#overlay").classList.remove("show");
}

async function downloadScorePNG(){
  saveStudentInfo();
  const card = $("#scoreCard");
  toast("æ­£åœ¨ç”¢ç”Ÿ PNGâ€¦");
  await new Promise(r=>setTimeout(r, 60));
  const canvas = await html2canvas(card, {scale: 2, backgroundColor: null});
  const a = document.createElement("a");
  a.download = `æˆç¸¾å¡_æ‡‰ç”¨æ–‡_${Date.now()}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
  toast("å·²ä¸‹è¼‰æˆç¸¾å¡ âœ…");
}

function clearGrade(){
  grade.startedAt = Date.now();
  grade.attempts = 0;
  grade.correct = 0;
  grade.completedModes = new Set();
  grade.wrongs = [];
  scoreDotUpdate();
  toast("å·²æ¸…ç©ºæœ¬æ¬¡ç´€éŒ„");
}

/* =========================================================
   UI Hook
   ========================================================= */
$("#resetBtn").addEventListener("click", ()=>build());
$("#shuffleBtn").addEventListener("click", ()=>build());

$$("#modeBar .pill").forEach(btn=>{
  if(btn.dataset.mode) btn.addEventListener("click", ()=>setMode(btn.dataset.mode));
});

$("#scoreBtn").addEventListener("click", openScore);
$("#closeBtn").addEventListener("click", closeScore);
$("#clearBtn").addEventListener("click", ()=>{
  clearGrade();
  closeScore();
});
$("#downloadBtn").addEventListener("click", downloadScorePNG);

$("#overlay").addEventListener("click", (e)=>{
  if(e.target.id==="overlay") closeScore();
});

/* Init */
scoreDotUpdate();
loadStudentInfo();
setMode("match-letter");
</script>
</body>
</html>
